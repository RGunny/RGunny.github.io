---
title: Java LiveStudy(1) - JVM
author: RGunny
date: 2021-01-01 18:00:00 +0900
updated: 2021-02-14 00:00:00 +0900
categories: [Java, liveStudy]
tags: [Java, liveStudy]
toc: false
---

## Goal

> 자바 소스 파일(.java)을 JVM으로 실행하는 과정 이해하기.

---

# 1.1 JVM(: Java Virsual Machine)`이란 무엇인가

> `JVM` : 자바를 실행해주는 머신(프로그램)

정확히는, 컴퓨터가 자바 바이트 코드로 컴파일된 모든 프로그램을 실행할 수 있도록 런타임 환경을 제공하는 소프트웨어 입니다.  
 어느 OS에서든 실행시키기 위해서 Java 애플리케이션은 JVM을 거친 후 OS를 거치게 되고, 해당 HW에 맞게 완전히 컴파일된 상태가 아닌 실행 시 해석(Interpret)되기 때문에 속도가 비교적 느리다는 단점이 있습니다. 하지만, 최근에 `Java Bytecode` (JVM이 실행하는 명령어의 형태이며, 자바에서 컴파일된 코드)를 HW의 기계어로 바로 변환해주는 `JIT 컴파일러` 등 향상된 기술로 인하여 속도의 차이를 크게 줄였습니다.

1. JAVA는 직접 실행 가능한 코드가 아닌, 바이트 코드를 생성
2. JVM이 바이트 코드를 기계어로 번역하여 실행  
   -> OS에 독립적으로 실행 가능

따라서, 아래와 같은 특징을 갖습니다.

- OS(: Operating System) 등 실행환경이 바뀌어도 `어디에서든 자바를 실행`할 수 있도록 도와줍니다.  
   이를 `Write once, run anywhere` 라고 많이 표현합니다. (HW 의존성이 낮다)
- `프로그램 메모리`를 관리하고 최적화 합니다. `(GC : Garbage Collector)`

ps. 영어권에서 Machine은 Computer를 뜻하기도 한다.

## 1.1.1 자바 바이트 코드란?

자바 바이트 코드(Java Bytecode)는 JVM이 실행하는 명령어의 형태로, 자바에서 컴파일된 코드를 말합니다.  
이로 인해, 특정 OS에 상관없이 독립적으로 작동할 수 있습니다.

---

# 1.2 컴파일 하는 방법

자바 소스 코드는(`.java`) 기본적으로 확장자가 .java인 text파일일 뿐입니다. 이 코드를 실행하기 위해서는, `.java 파일`을 `컴파일`을 통해 `.class`인 `바이트 코드` 파일을 만들어야 합니다.

1. 컴파일 : `.java -> .class`
2. `JVM`이 `.class` 실행

`JDK`(Java Development Kit) 자바 개발 도구를 설치하면 `bin` 디렉토리 안에 `javac`라는 Java Compiler가 포함되어 있습니다. 이로 인해 컴파일하려는 자바 파일 위치에서 javac 명령어를 통해 컴파일을 할 수 있습니다.

추가적으로, 자바는 기본적으로 상위버전에서 하위버전으로 호환이 유연합니다.  
하지만, 하위버전 컴파일러에서 상위버전으로 컴파일된 파일은 실행할 수 없습니다.  
따라서, 배포시에 하위버전의 호환성을 고려하여, 의도적으로 컴파일 버전을 낮춰서 (ex, Java 11을 사용하지만 Java 8로 컴파일) 컴파일하기도 합니다.  
이 때, 라이브러리가 지원하는 버전을 하위버전까지 확장할 수 있기에 더 많은 사용자를 확보할 수 있다는 장점은 있지만, 그 바이트 코드가 효율적이진 않습니다. 일반적으로 버전에 맞게 컴파일해야 최적화된 컴파일이 될 것입니다. 만약 상위버전 자바를 의도적으로 하위버전 자바로 컴파일 한다면, 상위버전에 있는 새 기능을 하위버전에서 커버하기 위해 더 복잡한 바이트 코드가 생성될 것입니다. 그리고 일부 기능은 안 옮겨질 수도 있습니다.

웬만하면 상위버전 LTS를 사용하고, 해당 버전에 맞게 컴파일 하자!  
p.s Library, Framework을 만들 때는 사용해야 하는 경우가 있다고 합니다.

## 1.2.1 javac Option

`$ javac <option> <source files>`

1. -classpath

   컴파일러가 컴파일 하기 위해 필요로 하는 클래스 파일을 찾기 위해, 컴파일 시 파일 경로를 지정하는 옵션

2. -d

   클래스 파일을 생성할 루트 디렉토리 지정

3. -sourcepath

   소스파일의 위치를 지정합니다.

4. -target

   지정된 Java version의 VM이 작동되도록 클래스 파일을 생성하는 옵셥ㄴ

# 1.3 실행하는 방법

java.exe 파일을 사용하여 .class 파일을 실행합니다.
`$ java Hello`

# 1.4 바이트코드란 무엇인가

바이트 코드(Bytecode)는 특정 HW가 아닌, 가상 컴퓨터에서 돌아가는 실행 프로그램을 위한 `이진 표기법`이며, 기계가 직접 실행하는 기계어가 아닌 중간 단계의 형태로 변환되는 것을 말합니다. HW가 아닌 SW에 의해 처리되기 때문에 보통 기계어보다 더 추상적입니다.  
 바이트 코드는 특정 HW에 대한 의존성을 줄이고, 해석(Interpret)하기 쉽게 프로그래밍 언어에 의해 생성되며, 컴파일되어 만들어진 바이트 코드는 특정 HW의 기계 코드를 만드는 컴파일러의 입력으로 사용되거나, 가상 컴퓨터(머신)에서 실행됩니다.

- 바이트 코드는 `.class` 파일 형태입니다.

# 1.5 JIT 컴파일러란 무엇이며 어떻게 동작하는지

`JIT` (: Just In Time) 컴파일러는 `정적 컴파일 방식`과 `인터프리터`가 합쳐진 방식으로, `바이트 코드`를 `기계어`로 `번역`하여 실행합니다.

프로그램을 실제 실행하는 시점에 기계어로 변환된 코드를 캐시에 저장하고, 이후 컴파일 시 변경된 부분만 컴파일하고 나머지는 캐싱된 코드를 사용합니다. 따라서, 같은 함수가 다시 호출될 때 (JIT 컴파일러가 실시간으로 실행되기 때문에 가능) 이미 캐싱되어 있는 메모리를 사용하므로 매번 기계어가 생성되는 것을 방지합니다.

ps. JIT 컴파일러는 `JRE` 안에 내장되어 있습니다.

# 1.6 JVM 구성 요소

1. Class Loader

클래스 로더는 컴파일된 바이트 코드들을(`.class`)를 읽어 연결한 뒤 `Run time Data Area`형태로 `메모리`에 저장하는 역할을 합니다. 내부적으로는 로딩, 링크, 초기화 단계가 있고, 초기화 단계에서 `전역 변수`를 `메모리 할당`에 할당하기 때문에 유의해야 합니다.

2. Runtime Data Area (메모리)

메모리는 런타임 시 필요한 메모리 영역으로, 스택, 힙, PC 레지스터, 메서드, 네이티브 메서드 스택이 있습니다.

3. Execution Engine (실행 엔진)

실행 엔진은 클래스 로더에 의해 실행에 필요한 준비 과정이 완료된 후, `인터프리터나 JIT 컴파일러를 통해 JVM 메모리 공간에 적재된 바이트 코드를 번역하여 실행`하는 역할을 합니다. 실행 엔진의 내부적으로는 Interpreter, JIT Compiler, GC 가 있습니다.

4. GC (Garbage Collector)

Heap 메모리 영역에 생성된 객체 중 주소가 사라져 사용할 수 없는 객체를 탐색 후 제거합니다.

# 1.7 JDK와 JRE의 차이

## 1.7.1 `JRE` (: Java Runtime Enviroment)

> JVM + 자바 클래스 라이브러리

JRE는 컴파일된 자바 프로그램을 실행시킬 수 있는 자바 환경입니다. JRE는 자바 프로그램을 실행할(동작시킬) 때 필요한 클래스 라이브러리(Java API)과 JVM을 가지고 있습니다.

클래스 라이브러리로 class를 실행 및 운영하며, JVM으로 자바로 작성된 응용프로그램이 실행되는 환경을 만들 수 있습니다.

JRE가 `.class`파일을 `JVM으로 로딩`시키고, `JVM`이 `.class` 파일을 `해석`하여 실행할 수 있는 상태로 만듭니다.

## 1.7.2 `JDK` (: Java Development Kit)

> JRE + 자바 애플리케이션 개발에 필요한 도구

`JDK`는 자바 애플리케이션 환경으로 JRE, 소스파일의 컴파일러 및 디버거 등 `자바 애플리케이션을 개발하기 위한 도구`들을 모두 포함합니다. 따라서, JDK안에 JRE가 포함되어 있습니다.

### References

- https://github.com/whiteship/live-study
- https://github.com/whiteship/live-study/issues/1
- https://youtu.be/T7NyR5UvyYo?t=4982
